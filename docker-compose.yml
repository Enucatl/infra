services:

  vault:
    image: hashicorp/vault:latest
    userns_mode: host
    restart: unless-stopped
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/file
      - ./vault/config:/vault/config
      - certificates:/certificates
    environment:
      - VAULT_LOG_LEVEL=info
    networks:
      - infra
    command: vault server -config /vault/config/vault-conf.hcl
    #command: vault server -config /vault/config/vault-conf-insecure.hcl

  vault-unsealer:
    image: nicolaka/netshoot:v0.14
    restart: unless-stopped
    depends_on:
      - vault
    environment:
      - CURL_CA_BUNDLE=${VAULT_CACERT}
      - KEYS_FILE
      - VAULT_ADDR
      - VAULT_CACERT
    volumes:
      - ./vault/scripts:/scripts
      - certificates:/certificates
    command: /scripts/unseal.sh
    networks:
      - infra

  freeipa:
    image: freeipa/freeipa-server:almalinux-10
    container_name: freeipa
    hostname: freeipa.home.arpa
    restart: unless-stopped
    networks:
      - infra
    ports:
      - "80:80"
      - "88:88"
      - "389:389"
      - "443:443"
      - "464:464"
      - "636:636"
    environment:
      # first run this to generate the CSR
      #- IPA_SERVER_INSTALL_OPTS=--unattended --realm HOME.ARPA --domain home.arpa --external-ca
      - IPA_SERVER_INSTALL_OPTS=--external_cert_file=/data/ipa.crt --external_ca_file=/data/ca.crt
      - PASSWORD
    volumes:
      - freeipa_data:/data
      - certificates:/certificates
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1

  # TEMPORARY CONTAINERS
  # only to document one-off setup

  # after running this, setup TLS for vault, changing the env and the config file
  vault-pki-core-setup:
    profiles:
      - setup
    image: hashicorp/vault:latest
    userns_mode: host
    restart: no
    depends_on:
      vault-unsealer:
        condition: service_completed_successfully
    environment:
      - VAULT_ADDR
      - KEYS_FILE
    volumes:
      - ./vault/scripts:/scripts
      - certificates:/certificates
    networks:
      - infra
    entrypoint: /scripts/01-pki-core-setup.sh

  vault-pki-intermediate-setup:
    profiles:
      - setup
    image: hashicorp/vault:latest
    userns_mode: host
    restart: "no"
    depends_on:
      vault-unsealer:
        condition: service_completed_successfully
    environment:
      - KEYS_FILE
      - VAULT_ADDR
      - VAULT_CACERT
    volumes:
      - ./vault/scripts:/scripts
      - certificates:/certificates
    entrypoint: /scripts/02-pki-intermediate.sh
    networks:
      - infra

  freeipa-sign-csr:
    profiles:
      - setup
    image: hashicorp/vault:latest
    userns_mode: host
    restart: "no"
    depends_on:
      vault-unsealer:
        condition: service_completed_successfully
    environment:
      - KEYS_FILE
      - VAULT_ADDR
      - VAULT_CACERT
    volumes:
      - ./vault/scripts:/scripts
      - freeipa_data:/data
      - certificates:/certificates
    entrypoint: /scripts/04-sign-csr.sh
    networks:
      - infra

networks:
  infra:
    name: infra
    enable_ipv6: true
    ipam:
      driver: default

volumes:
  vault_data:
  freeipa_data:
  certificates:
